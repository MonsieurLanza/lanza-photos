 <!DOCTYPE html>
<html lang="fr">
  <head>
    <!-- Required meta tags always come first -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/css/bootstrap.min.css" integrity="sha384-AysaV+vQoT3kOAXZkl02PThvDr8HYKPZhNT5h/CXfBThSRXQ6jW5DO2ekP5ViFdi" crossorigin="anonymous">
    <link rel="stylesheet" href="css/base.css">
  </head>
  <body class="container-fluid">
    <nav class="navbar navbar-light">
        <ul class="nav navbar-nav">
          <li class="nav-item active"><a href="#" class="nav-link">Fil de Photos</a></li>
          <li class="nav-item"><a href="#" class="nav-link">Public</a></li>
        </ul>
    </nav>
    <section id="photo-view">
    {{{ plop }}}

    <form method="post" enctype="multipart/form-data" action="photos">
        <input type="file" accept="image/*" name="file" id="photo-input">
        <input type="submit" name="Téléverser">
    </form>
    </section>
    <!-- jQuery first, then Tether, then Bootstrap JS. -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js" integrity="sha384-3ceskX3iaEnIogmQchP8opvBy3Mi7Ce34nWjpBIwVTHfGYWQS9jwHDVRnpKKHJg7" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.7/js/tether.min.js" integrity="sha384-XTs3FgkjiBgo8qjEjBk0tGmf3wPrWtA6coPfQDfFEY8AnYJwjalXCiosYRBIBZX8" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/js/bootstrap.min.js" integrity="sha384-BLiI7JTZm+JWlgKa0M0kGRpJbF2J8q+qreVrKBC47e3K6BW78kGLrCkeRX6I9RoK" crossorigin="anonymous"></script>
    <script src="js/tus.min.js"></script>
    <script src="js/flex-images.min.js"></script>
    <script type="text/javascript">
        var droptarget = document.getElementById('photo-view');
        droptarget.addEventListener('dragenter', drag, false);
        droptarget.addEventListener('dragover', drag, false);
        droptarget.addEventListener('drop', dropFile, false);
        droptarget.addEventListener('dragleave', unDrag, false);

        function drag(e) {
            e.stopPropagation();
            e.preventDefault();

            highLightTarget(e.currentTarget);
        }

        function unDrag(e) {
            e.stopPropagation();
            e.preventDefault();

            downLightTarget(e.currentTarget);
        }

        function dropFile(e) {
            e.stopPropagation();
            e.preventDefault();

            var dt = e.dataTransfer;
            var files = dt.files;

            downLightTarget(e.currentTarget);

            batchUploads(files);
        }

        function highLightTarget(target) {
            target.classList.add("dragover");
        }

        function downLightTarget(target) {
            target.classList.remove("dragover");
        }

        var input = document.getElementById("photo-input");
        input.addEventListener("change", function(e) {
            // Get the selected file from the input element
            var file = e.target.files[0];
            uploadFile(file);

        });

        var batchUploads = function(files) {
            for(var i in files) {
                uploadFile(files[i]);
            }
        }

        var uploadFile = function(file) {
            // Create a new tus upload
            var upload = new tus.Upload(file, {
                endpoint: "http://localhost:9104/apps/lanza-photos/uploads/",
                retryDelays: [0, 1000, 3000, 5000],
                metadata: {fileName: file.name},
                onError: function(error) {
                    console.log("Failed because: " + error)
                },
                onProgress: function(bytesUploaded, bytesTotal) {
                    var percentage = (bytesUploaded / bytesTotal * 100).toFixed(2)
                },
                onSuccess: function() {
                    console.log("Download %s", upload.file.name)
                }
            })

            // Start the upload
            upload.start()
        }
    </script>
  </body>
</html>
